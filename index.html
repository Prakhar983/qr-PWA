<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <title>QR Code Scanner PWA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <h1>QR Code Scanner</h1>
    <div id="logdata"></div>
    <div id="reader" style="width:600px;"></div>
    <button id="startScan">Start Scanning</button>


    <script>
        const reader = new Html5Qrcode("reader");
        function logdata(logentry){
            var logdiv = document.getElementById("logdata")
            logdiv.innerHTML = logentry
        }
        document.getElementById("startScan").addEventListener("click", async () => {
            // Get GPS coordinates
            navigator.geolocation.getCurrentPosition(async (position) => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                const timestamp = new Date().toISOString();

                // Start scanning for QR codes
                reader.start(
                    { facingMode: "environment" }, // Use rear camera
                    {
                        fps: 10,
                        qrbox: 250
                    },
                    (decodedText, decodedResult) => {
                        // Stop scanning after successful read
                        reader.stop();
                        
                        // Create JSON object with data
                        const jsonData = {
                            timestamp: timestamp,
                            latitude: latitude,
                            longitude: longitude,
                            qrcodeData: decodedText
                        };

                        logdata(JSON.stringify(jsonData));
                    },
                    (errorMessage) => {
                        // Handle errors if needed
                        logdata(`QR Code scan error: ${errorMessage}`);
                    }
                ).catch(err => {
                    logdata(`Unable to start scanning: ${err}`);
                });
            }, (error) => {
                logdata(`Geolocation error: ${error.message}`);
            });
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        logdata('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        logdata('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
      
</body>
</html>
 -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <title>QR Code Scanner PWA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <h1>QR Code Scanner PWA</h1>
    <div id="auth-section">
        <h2>Sign In</h2>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button id="signIn">Sign In</button>
        <div id="authMessage"></div>
    </div>
    <div id="scanner-section" style="display: none;">
        <h2>QR Code Scanner</h2>
        <div id="logdata"></div>
        <div id="reader" style="width: 100%; max-width: 600px; height: auto; margin: auto;"></div>
        <button id="startScan">Start Scanning</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQErS-EG_X1enQq-WQY4alWGeGSb_0Y58",
            authDomain: "deliverytracker-eefb5.firebaseapp.com",
            databaseURL: "https://deliverytracker-eefb5-default-rtdb.firebaseio.com",
            projectId: "deliverytracker-eefb5",
            storageBucket: "deliverytracker-eefb5.appspot.com",
            messagingSenderId: "1062417903444",
            appId: "1:1062417903444:web:ce50e1e70c959cf053a2c1",
            measurementId: "G-ZG5N8VMSWZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const authSection = document.getElementById("auth-section");
        const scannerSection = document.getElementById("scanner-section");
        const authMessage = document.getElementById("authMessage");

        // Sign-in logic
        document.getElementById("signIn").addEventListener("click", () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    authSection.style.display = "none";
                    scannerSection.style.display = "block";
                    authMessage.innerHTML = "";
                })
                .catch(error => {
                    authMessage.innerHTML = `Sign-in error: ${error.message}`;
                });
        });

        // QR Code Scanner
        const reader = new Html5Qrcode("reader");

        function logData(message) {
            const logDiv = document.getElementById("logdata");
            logDiv.innerHTML = message;
        }

        document.getElementById("startScan").addEventListener("click", () => {
            logData("Starting scanner...");

            navigator.geolocation.getCurrentPosition((position) => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                const timestamp = Date.now();

                const user = auth.currentUser;
                if (!user) {
                    logData("User not authenticated.");
                    return;
                }

                const userEmail = user.email.replace(".", "-");
                
                reader.start(
                    { facingMode: "environment" }, // Use the rear camera
                    { fps: 10, qrbox: { width: 250, height: 250 } }, // Square scanner box
                    (decodedText) => {
                        // Replace invalid characters with "_"
                        const safeDecodedText = decodedText.replace(/[.#$[\]]/g, "_");

                        reader.stop().then(() => {
                            logData(`QR Code scanned: ${decodedText}`);

                            // Prepare data object
                            const data = { coordinates: { x: latitude, y: longitude }, timestamp };

                            // Correct Firebase path and set data using the sanitized key
                            const path = `data/scans/${userEmail}/${safeDecodedText}`;
                            database.ref(path).set(data)
                                .then(() => {
                                    logData("Data sent to Firebase successfully!");
                                })
                                .catch(error => {
                                    logData(`Error sending data to Firebase: ${error.message}`);
                                });
                        });
                    },
                    (errorMessage) => {
                        // Log errors during scanning
                        logData(`QR Code scanning error: ${errorMessage}`);
                    }
                )
                .catch((error) => {
                    logData(`Error starting the scanner: ${error.message}`);
                });
            }, (error) => {
                logData(`Geolocation error: ${error.message}`);
            });
        });
    </script>
</body>
</html>
