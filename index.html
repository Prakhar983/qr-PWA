<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <title>Delivery Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        /* Mobile responsive styling for the table */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th, table td {
            text-align: left;
            padding: 8px;
            word-wrap: break-word;
        }
        table th {
            background-color: #f2f2f2;
        }
        table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 150px;
        }
        @media (max-width: 600px) {
            table th, table td {
                padding: 6px;
            }
            table td {
                max-width: 100px;
            }
        }

        /* Button positioned at the bottom middle */
        #addScanButton {
            position: fixed;
            bottom: 20px;  /* Adjust the distance from the bottom */
            left: 50%;
            transform: translateX(-50%);  /* Center horizontally */
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        #addScanButton:hover {
            background-color: #45a049;
        }


    </style>
</head>
<body>
    <h1>Delivery Tracker</h1>

    <!-- Screen 1: Sign In -->
    <div id="auth-section">
        <h2>Sign In</h2>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button id="signIn">Sign In</button>
        <div id="authMessage"></div>
    </div>

    <!-- Screen 2: Scanned Data Table -->
    <div id="scanner-section" style="display: none;">
        <h2>Scanned Data</h2>
        <div style="max-height: 400px; overflow-y: auto;">
            <table id="scannedDataTable" border="1" cellpadding="10" style="width: 100%; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; background-color: #f2f2f2;">
                    <tr>
                        <th>QR Data</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody id="scannedDataBody">
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>
        <button id="addScanButton">Add Scan</button>
    </div>

    <!-- Screen 3: QR Code Scanner -->
    <div id="scanner-view" style="display: none;">
        <h2>QR Code Scanner</h2>
        <div id="logdata"></div>
        <div id="reader" style="width: 100%; max-width: 600px; height: auto; margin: auto;"></div>
        <button id="startScan">Start Scanning</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQErS-EG_X1enQq-WQY4alWGeGSb_0Y58",
            authDomain: "deliverytracker-eefb5.firebaseapp.com",
            databaseURL: "https://deliverytracker-eefb5-default-rtdb.firebaseio.com",
            projectId: "deliverytracker-eefb5",
            storageBucket: "deliverytracker-eefb5.appspot.com",
            messagingSenderId: "1062417903444",
            appId: "1:1062417903444:web:ce50e1e70c959cf053a2c1",
            measurementId: "G-ZG5N8VMSWZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const authSection = document.getElementById("auth-section");
        const scannerSection = document.getElementById("scanner-section");
        const scannerView = document.getElementById("scanner-view");
        const authMessage = document.getElementById("authMessage");
        const startScanButton = document.getElementById("startScan");
        let scannerActive = false;
        let reader = null;

        // Sign-in logic
        document.getElementById("signIn").addEventListener("click", () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    authSection.style.display = "none";
                    scannerSection.style.display = "block";
                    authMessage.innerHTML = "";
                    loadScannedData(); // Load the scanned data for the user
                })
                .catch(error => {
                    authMessage.innerHTML = `Sign-in error: ${error.message}`;
                });
        });

        // Show QR code scanner view
        document.getElementById("addScanButton").addEventListener("click", () => {
            scannerSection.style.display = "none";
            scannerView.style.display = "block";
        });

        // Show the scanned data table
        function showScannerSection() {
            scannerView.style.display = "none";
            scannerSection.style.display = "block";
            loadScannedData(); // Reload the scanned data
        }

        // QR Code Scanner logic
        function startScanning() {
            navigator.geolocation.getCurrentPosition((position) => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                const user = auth.currentUser;
                if (!user) {
                    logData("User not authenticated.");
                    return;
                }

                const userEmail = user.email.replace(".", "-");

                reader = new Html5Qrcode("reader");

                reader.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: { width: 250, height: 250 } }, 
                    (decodedText) => {
                        const safeDecodedText = decodedText.replace(/[.,#\[\\\]$/]/g, '-');

                        reader.stop().then(() => {
                            logData(`QR Code scanned: ${decodedText}`);

                            const data = {
                                coordinates: { x: latitude, y: longitude },
                                timestamp: firebase.database.ServerValue.TIMESTAMP 
                            };

                            const path = `data/scans/${userEmail}/${safeDecodedText}`;
                            const ref = database.ref(path);

                            ref.once('value', (snapshot) => {
                                if (snapshot.exists()) {
                                    ref.update(data).then(() => {
                                        logData("Data updated in Firebase successfully!");
                                        showScannerSection(); 
                                    }).catch(error => {
                                        //logData(`Error updating data in Firebase: ${error.message}`);
                                    });
                                } else {
                                    ref.set(data).then(() => {
                                        logData("Data sent to Firebase successfully!");
                                        showScannerSection();
                                    }).catch(error => {
                                        logData(`Error sending data to Firebase: ${error.message}`);
                                    });
                                }
                            });
                        });
                    },
                    (errorMessage) => {
                        //logData(`QR Code scanning error: ${errorMessage}`);
                    }
                )
                .catch((error) => {
                    //logData(`Error starting the scanner: ${error.message}`);
                });
                scannerActive = true;
                startScanButton.innerText = "Stop Scanning";
            }, (error) => {
                //logData(`Geolocation error: ${error.message}`);
            });
        }

        function stopScanning() {
            if (reader) {
                reader.stop().then(() => {
                    logData("Scanning stopped.");
                    scannerActive = false;
                    startScanButton.innerText = "Start Scanning";
                    showScannerSection()
                }).catch((error) => {
                    //logData(`Error stopping the scanner: ${error.message}`);
                });
            }
        }

        startScanButton.addEventListener("click", () => {
            if (scannerActive) {
                stopScanning();
            } else {
                startScanning();
            }
        });

        // Function to load the scanned data from Firebase
        function loadScannedData() {
            const user = auth.currentUser;
            if (!user) {
                return;
            }

            const userEmail = user.email.replace(".", "-");
            const path = `data/scans/${userEmail}`;

            // Get all the scans for the current user
            database.ref(path).once('value', (snapshot) => {
                const data = snapshot.val();
                const scannedDataBody = document.getElementById("scannedDataBody");
                scannedDataBody.innerHTML = ''; // Clear previous data

                if (data) {
                    const scanEntries = Object.keys(data).map(key => {
                        const scan = data[key];
                        const timestamp = new Date(scan.timestamp);
                        return {
                            key,
                            timestamp,
                            scan
                        };
                    });

                    scanEntries.sort((a, b) => b.timestamp - a.timestamp);

                    scanEntries.forEach(entry => {
                        const scan = entry.scan;
                        const timestamp = entry.timestamp;
                        const formattedDate = timestamp.toLocaleDateString();
                        const formattedTime = timestamp.toLocaleTimeString();

                        const formattedLatitude = scan.coordinates.x.toFixed(5);
                        const formattedLongitude = scan.coordinates.y.toFixed(5);

                        const truncatedBarcodeData = entry.key.length > 10 ? entry.key.slice(0, 8) + "..." : entry.key;

                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${truncatedBarcodeData}</td>
                            <td>${formattedLatitude}</td>
                            <td>${formattedLongitude}</td>
                            <td>${formattedDate}<br>${formattedTime}</td>
                        `;
                        scannedDataBody.appendChild(row);
                    });
                } else {
                    logData("No scans found.");
                }
            });
        }

        function logData(message) {
            const logDiv = document.getElementById("logdata");
            logDiv.innerHTML = message;
        }
    </script>
</body>
</html>



<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <title>QR Code Scanner PWA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <h1>QR Code Scanner PWA</h1>
    <div id="auth-section">
        <h2>Sign In</h2>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button id="signIn">Sign In</button>
        <div id="authMessage"></div>
    </div>
    <div id="scanner-section" style="display: none;">
        <h2>QR Code Scanner</h2>
        <div id="logdata"></div>
        <div id="reader" style="width: 100%; max-width: 600px; height: auto; margin: auto;"></div>
        <button id="startScan">Start Scanning</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQErS-EG_X1enQq-WQY4alWGeGSb_0Y58",
            authDomain: "deliverytracker-eefb5.firebaseapp.com",
            databaseURL: "https://deliverytracker-eefb5-default-rtdb.firebaseio.com",
            projectId: "deliverytracker-eefb5",
            storageBucket: "deliverytracker-eefb5.appspot.com",
            messagingSenderId: "1062417903444",
            appId: "1:1062417903444:web:ce50e1e70c959cf053a2c1",
            measurementId: "G-ZG5N8VMSWZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const authSection = document.getElementById("auth-section");
        const scannerSection = document.getElementById("scanner-section");
        const authMessage = document.getElementById("authMessage");

        // Sign-in logic
        document.getElementById("signIn").addEventListener("click", () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    authSection.style.display = "none";
                    scannerSection.style.display = "block";
                    authMessage.innerHTML = "";
                })
                .catch(error => {
                    authMessage.innerHTML = `Sign-in error: ${error.message}`;
                });
        });

        // QR Code Scanner
        const reader = new Html5Qrcode("reader");

        function logData(message) {
            const logDiv = document.getElementById("logdata");
            logDiv.innerHTML = message;
        }

        document.getElementById("startScan").addEventListener("click", () => {
    logData("Starting scanner...");

    navigator.geolocation.getCurrentPosition((position) => {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        const user = auth.currentUser;
        if (!user) {
            logData("User not authenticated.");
            return;
        }

        const userEmail = user.email.replace(".", "-");

        reader.start(
            { facingMode: "environment" }, // Use the rear camera
            { fps: 10, qrbox: { width: 250, height: 250 } }, // Square scanner box
            (decodedText) => {
                // Replace invalid characters with "_"
                const safeDecodedText = decodedText.replace(/[.,#\[\\\]$/]/g, '-');

                reader.stop().then(() => {
                    logData(`QR Code scanned: ${decodedText}`);

                    // Prepare data object with Firebase server timestamp
                    const data = {
                        coordinates: { x: latitude, y: longitude },
                        timestamp: firebase.database.ServerValue.TIMESTAMP // Use Firebase's server timestamp
                    };

                    // Correct Firebase path and check if data already exists
                    const path = `data/scans/${userEmail}/${safeDecodedText}`;
                    const ref = database.ref(path);

                    // Check if data exists for the QR code
                    ref.once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            // If data exists, update the data
                            ref.update(data)
                                .then(() => {
                                    logData("Data updated in Firebase successfully!");
                                })
                                .catch(error => {
                                    logData(`Error updating data in Firebase: ${error.message}`);
                                });
                        } else {
                            // If data does not exist, set new data
                            ref.set(data)
                                .then(() => {
                                    logData("Data sent to Firebase successfully!");
                                })
                                .catch(error => {
                                    logData(`Error sending data to Firebase: ${error.message}`);
                                });
                        }
                    });
                });
            },
            (errorMessage) => {
                // Log errors during scanning
                logData(`QR Code scanning error: ${errorMessage}`);
            }
        )
        .catch((error) => {
            logData(`Error starting the scanner: ${error.message}`);
        });
    }, (error) => {
        logData(`Geolocation error: ${error.message}`);
    });
});

    </script>
</body>
</html>
 -->
